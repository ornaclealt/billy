<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secreto Wall</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Compression Lib -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fafafa; color: #171717; -webkit-tap-highlight-color: transparent; }
        
        /* Animasi munculnya pesan satu per satu */
        #feed-container > div {
            animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) both;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Secreto Style Background */
        .bg-pattern {
            background-color: #fafafa;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Smooth Scroll & Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .recording-active { animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }

        /* Audio Player Styling */
        audio { height: 32px; width: 100%; border-radius: 999px; }
        audio::-webkit-media-controls-panel { background-color: #f3f4f6; }
        
        /* Mobile Optimizations */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden bg-pattern selection:bg-black selection:text-white">

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs px-4 pointer-events-none"></div>

    <!-- NAVBAR -->
    <nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-gray-200">
        <div class="max-w-xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href = window.location.href.split('?')[0]">
                <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white shadow-lg transform hover:rotate-3 transition">
                    <i data-lucide="ghost" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-lg tracking-tight text-gray-900">Secreto Wall</span>
            </div>
            
            <div class="flex items-center gap-3">
                <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-gray-300 transition-colors duration-500" title="Offline"></div>
            </div>
        </div>
    </nav>

    <!-- CONTAINER UTAMA -->
    <main class="flex-grow w-full max-w-xl mx-auto px-4 py-8 relative">

        <!-- VIEW 1: LANDING PAGE -->
        <div id="view-landing" class="hidden flex flex-col items-center justify-center text-center py-10 animate-enter">
            <div class="w-24 h-24 bg-gradient-to-tr from-gray-800 to-black rounded-3xl flex items-center justify-center text-white shadow-2xl mb-6 rotate-3">
                <i data-lucide="venetian-mask" class="w-12 h-12"></i>
            </div>
            
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4 tracking-tight leading-tight">
                Pesan Jujur.<br>Tanpa Nama.
            </h1>
            <p class="text-gray-500 text-lg max-w-xs mx-auto mb-10 leading-relaxed font-medium">
                Buat ruang rahasiamu sendiri. Biarkan teman mengirim pesan, foto, dan suara secara anonim.
            </p>

            <button onclick="app.createRoom()" class="group relative w-full max-w-xs py-4 bg-black text-white text-base font-bold rounded-2xl shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all overflow-hidden flex items-center justify-center gap-3">
                <span>Buat Link Saya</span>
                <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
            </button>

            <!-- Resume Button -->
            <div id="resume-session-card" class="hidden mt-6 w-full max-w-xs p-4 bg-white border border-gray-200 rounded-2xl shadow-sm text-left flex items-center justify-between cursor-pointer hover:border-gray-400 transition" onclick="app.goToMyRoom()">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-0.5">Lanjutkan</p>
                    <p class="text-sm font-bold text-gray-900">Masuk ke Room Anda</p>
                </div>
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-900">
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </div>
            </div>
        </div>

        <!-- VIEW 2: ROOM PAGE -->
        <div id="view-room" class="hidden pb-24">
            
            <!-- Room Header -->
            <div class="text-center mb-8 animate-enter relative">
                
                <!-- Avatar & Status -->
                <div class="relative inline-block mb-4 group">
                    <div class="p-1 bg-white rounded-full shadow-lg">
                        <img id="room-avatar" src="" class="w-24 h-24 rounded-full object-cover bg-gray-100">
                        <div id="room-avatar-fallback" class="hidden w-24 h-24 rounded-full bg-gradient-to-tr from-gray-700 to-black flex items-center justify-center text-white text-3xl font-bold">?</div>
                    </div>
                    <div id="badge-owner" class="hidden absolute bottom-1 right-1 bg-black text-white text-[10px] font-bold px-2 py-0.5 rounded-full border-2 border-white shadow-sm">OWNER</div>
                </div>
                
                <h1 id="room-name" class="text-2xl font-extrabold text-gray-900 mb-2 tracking-tight">Memuat...</h1>
                <p id="room-desc" class="text-gray-500 text-sm max-w-xs mx-auto mb-6 leading-relaxed">...</p>

                <!-- Action Buttons (Owner) -->
                <div id="owner-actions" class="hidden flex justify-center gap-3 mb-6">
                    <button onclick="ui.openModal('modal-settings')" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition shadow-sm">
                        <i data-lucide="settings" class="w-4 h-4"></i> Edit Room
                    </button>
                    <button onclick="app.copyLink()" class="flex items-center gap-2 px-4 py-2 bg-black text-white rounded-xl text-xs font-bold hover:bg-gray-800 transition shadow-lg shadow-gray-200">
                        <i data-lucide="copy" class="w-4 h-4"></i> Salin Link
                    </button>
                </div>

                <!-- Action Button (Visitor) -->
                <div id="visitor-actions" class="hidden flex justify-center mb-6">
                    <button onclick="app.copyLink()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-500 hover:text-gray-900 transition shadow-sm">
                        <i data-lucide="share-2" class="w-4 h-4"></i> Share Link Ini
                    </button>
                </div>
            </div>

            <!-- Input Form -->
            <section class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8 transition-all hover:shadow-md relative z-10">
                <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider pl-1">Kirim Pesan</h2>
                    <div class="text-[10px] font-bold px-2 py-1 bg-gray-900 text-white rounded">ANONIM</div>
                </div>
                
                <div class="p-4">
                    <input type="text" id="input-sender" placeholder="Nama samaran (Opsional)" class="block w-full text-sm font-semibold text-gray-800 placeholder-gray-400 border-none focus:ring-0 p-0 mb-3 bg-transparent">
                    
                    <textarea id="input-message" rows="3" placeholder="Tulis pesan rahasia di sini..." class="block w-full text-base text-gray-900 placeholder-gray-400 border-none focus:ring-0 p-0 bg-transparent resize-none"></textarea>

                    <!-- Previews -->
                    <div id="preview-area" class="hidden mt-3 p-3 bg-gray-50 rounded-xl border border-gray-100 relative">
                        <img id="preview-img" class="hidden h-24 w-auto rounded-lg object-cover border border-gray-200 shadow-sm">
                        <audio id="preview-audio" controls class="hidden"></audio>
                        <div id="preview-file" class="hidden flex items-center gap-2 text-sm text-gray-600 bg-white p-2 rounded-lg border border-gray-200">
                            <i data-lucide="file-text" class="w-4 h-4"></i> <span id="preview-filename" class="truncate max-w-[150px]">file.pdf</span>
                        </div>
                        <button onclick="media.clear()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                    
                    <div class="flex justify-between items-center pt-3 mt-2 border-t border-dashed border-gray-100">
                        <div class="flex items-center gap-1">
                            <label class="cursor-pointer text-gray-400 hover:text-gray-900 transition p-2 hover:bg-gray-100 rounded-full" title="Upload Foto">
                                <i data-lucide="image" class="w-5 h-5"></i>
                                <input type="file" id="file-image" accept="image/*" class="hidden" onchange="media.handleImage(this)">
                            </label>
                            
                            <label class="cursor-pointer text-gray-400 hover:text-gray-900 transition p-2 hover:bg-gray-100 rounded-full" title="Upload Dokumen">
                              <i data-lucide="file-plus" class="w-5 h-5"></i>
                                <input type="file" id="file-doc" accept=".pdf,.doc,.docx,.txt" class="hidden" onchange="media.handleDocument(this)">
                            </label>
                            
                            <button id="btn-record" onclick="media.toggleRecording()" class="text-gray-400 hover:text-red-600 transition p-2 hover:bg-red-50 rounded-full flex items-center gap-2">
                                <i data-lucide="mic" class="w-5 h-5"></i>
                                <span id="recording-timer" class="hidden text-xs font-mono font-bold text-red-600 animate-pulse">00:00</span>
                            </button>
                        </div>

                        <button onclick="app.sendMessage()" id="btn-send" class="px-5 py-2 bg-black text-white text-sm font-bold rounded-xl hover:bg-gray-800 transition shadow-lg transform active:scale-95 flex items-center gap-2">
                            <span>Kirim</span> <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Timeline Header -->
            <div class="px-2 mb-6 space-y-4 animate-enter">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="p-1.5 bg-black text-white rounded-lg shadow-sm">
                            <i data-lucide="layout-list" class="w-4 h-4"></i>
                        </div>
                        <h3 class="font-bold text-gray-900 text-sm tracking-tight">Timeline Pesan</h3>
                    </div>
                    <div class="flex items-center gap-1.5 bg-white border border-gray-100 px-3 py-1 rounded-full shadow-sm">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        <span id="msg-count" class="text-[11px] font-black text-gray-700">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-2">
                    <div class="col-span-8 relative group">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-black group-focus-within:scale-110 transition-all duration-300"></i>
                        <input type="text" id="search-input" oninput="app.listenMessages()" placeholder="Cari kata kunci..." 
                            class="w-full pl-10 pr-4 py-2.5 bg-white/60 backdrop-blur-sm border border-gray-200 rounded-2xl text-xs font-medium placeholder:text-gray-400 focus:bg-white focus:border-black focus:ring-4 focus:ring-black/5 outline-none transition-all duration-300 shadow-sm">
                    </div>
                    
                    <div class="col-span-4 relative">
                        <i data-lucide="sliders-horizontal" class="w-3.5 h-3.5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        <select id="sort-select" onchange="app.listenMessages()" 
                            class="w-full appearance-none bg-white/60 backdrop-blur-sm border border-gray-200 rounded-2xl pl-4 pr-10 py-2.5 text-xs font-bold text-gray-700 focus:bg-white focus:border-black outline-none transition-all duration-300 shadow-sm cursor-pointer">
                            <option value="newest">Terbaru</option>
                            <option value="oldest">Terlama</option>
                            <option value="popular">Populer</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Feed Container -->
            <div id="feed-container" class="space-y-4 pb-10">
                <!-- Messages will load here -->
            </div>

        </div>
    </main>

    <!-- MODAL EDIT PROFILE -->
    <div id="modal-settings" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-enter">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform scale-100 transition-all">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80">
                <h3 class="font-bold text-gray-900">Edit Profil Room</h3>
                <button onclick="ui.closeModal('modal-settings')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-5 space-y-5">
                <!-- Avatar Upload -->
                <div class="flex flex-col items-center">
                    <div class="relative w-24 h-24 group cursor-pointer">
                        <img id="edit-avatar-preview" src="" class="w-full h-full rounded-full object-cover border-4 border-gray-100 shadow-sm">
                        <div id="edit-avatar-placeholder" class="absolute inset-0 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 border-4 border-white hidden">
                            <i data-lucide="image" class="w-8 h-8"></i>
                        </div>
                        <div class="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white">
                            <i data-lucide="camera" class="w-8 h-8"></i>
                        </div>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="media.handleAvatarUpload(this)">
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 font-medium">Ketuk foto untuk mengganti</p>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Room</label>
                        <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-semibold focus:border-black focus:bg-white outline-none transition" placeholder="Contoh: Ruang Curhat Budi">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Deskripsi</label>
                        <textarea id="edit-desc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-medium focus:border-black focus:bg-white outline-none transition resize-none" placeholder="Tulis sesuatu..."></textarea>
                    </div>
                </div>
                
                <button onclick="app.saveProfile()" class="w-full py-3 bg-black text-white font-bold rounded-xl shadow-lg hover:bg-gray-800 transition active:scale-95">
                    Simpan Perubahan
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC SYSTEM -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, query, where, updateDoc, arrayUnion, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApD7dueaFuPv9hHGajcwo17LADEVriqRw",
            authDomain: "entry-6a64d.firebaseapp.com",
            projectId: "entry-6a64d",
            storageBucket: "entry-6a64d.firebasestorage.app",
            messagingSenderId: "939693440034",
            appId: "1:939693440034:web:ecd3d0366acf207add1e7b",
            measurementId: "G-RPTFXQK08B"
        };

        let db, auth, user;
        let currentRoomId = null;
        let isOwner = false;
        
        let currentFile = { base64: null, type: null, name: null };
        let recorder = null, audioChunks = [], recordStartTime = 0, recordInterval = null;

        const ui = {
            showToast: (msg, type = 'info') => {
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-600' : 'bg-gray-900');
                el.className = `${colors} text-white text-xs font-bold px-4 py-3 rounded-xl shadow-xl transform transition-all duration-300 translate-y-[-20px] opacity-0 flex items-center gap-2 pointer-events-auto`;
                el.innerHTML = `<span>${msg}</span>`;
                document.getElementById('toast-container').appendChild(el);
                requestAnimationFrame(() => el.classList.remove('translate-y-[-20px]', 'opacity-0'));
                setTimeout(() => {
                    el.classList.add('translate-y-[-20px]', 'opacity-0');
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },
            updateStatus: (isOnline) => {
                const el = document.getElementById('connection-status');
                if(el) el.className = isOnline ? "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]" : "w-2.5 h-2.5 rounded-full bg-red-500";
            },
            switchView: (viewId) => {
                ['view-landing', 'view-room'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                lucide.createIcons();
            },
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden')
        };

        const media = {
            handleImage: async (input) => {
                const file = input.files[0];
                if (!file) return;
                try {
                    const compressedFile = await imageCompression(file, { maxSizeMB: 0.5, maxWidthOrHeight: 1024 });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentFile = { base64: e.target.result, type: 'image', name: file.name };
                        document.getElementById('preview-img').src = e.target.result;
                        document.getElementById('preview-img').classList.remove('hidden');
                        document.getElementById('preview-area').classList.remove('hidden');
                    };
                    reader.readAsDataURL(compressedFile);
                } catch (error) { ui.showToast('Gagal proses gambar', 'error'); }
            },
            handleDocument: (input) => {
                const file = input.files[0];
                if (!file) return;
                if (file.size > 2 * 1024 * 1024) { ui.showToast('File max 2MB', 'error'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentFile = { base64: e.target.result, type: 'file', name: file.name };
                    document.getElementById('preview-filename').innerText = file.name;
                    document.getElementById('preview-file').classList.remove('hidden');
                    document.getElementById('preview-area').classList.remove('hidden');
                    ui.showToast('Dokumen siap!', 'success');
                };
                reader.readAsDataURL(file);
            },
            toggleRecording: async () => {
                if (recorder && recorder.state === "recording") {
                    recorder.stop();
                    clearInterval(recordInterval);
                    document.getElementById('btn-record').classList.remove('recording-active', 'text-red-600', 'bg-red-50');
                    document.getElementById('recording-timer').classList.add('hidden');
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        recorder = new MediaRecorder(stream);
                        audioChunks = [];
                        recorder.ondataavailable = e => audioChunks.push(e.data);
                        recorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: 'audio/mp3' });
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                currentFile = { base64: e.target.result, type: 'audio', name: 'Voice Note' };
                                document.getElementById('preview-audio').src = e.target.result;
                                document.getElementById('preview-audio').classList.remove('hidden');
                                document.getElementById('preview-area').classList.remove('hidden');
                            };
                            reader.readAsDataURL(blob);
                        };
                        recorder.start();
                        recordStartTime = Date.now();
                        document.getElementById('btn-record').classList.add('recording-active', 'text-red-600', 'bg-red-50');
                        document.getElementById('recording-timer').classList.remove('hidden');
                        recordInterval = setInterval(() => {
                            const diff = Math.floor((Date.now() - recordStartTime) / 1000);
                            const m = Math.floor(diff / 60).toString().padStart(2, '0');
                            const s = (diff % 60).toString().padStart(2, '0');
                            document.getElementById('recording-timer').innerText = `${m}:${s}`;
                        }, 1000);
                    } catch (e) { ui.showToast('Izin mic ditolak', 'error'); }
                }
            },
            handleAvatarUpload: (input) => {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('edit-avatar-preview').src = e.target.result;
                    document.getElementById('edit-avatar-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            },
            clear: () => {
                currentFile = { base64: null, type: null, name: null };
                document.getElementById('preview-area').classList.add('hidden');
                document.getElementById('preview-img').classList.add('hidden');
                document.getElementById('preview-audio').classList.add('hidden');
                document.getElementById('preview-file').classList.add('hidden');
                document.getElementById('file-image').value = '';
                if(document.getElementById('file-doc')) document.getElementById('file-doc').value = '';
            }
        };

        const app = {
            init: async () => {
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    auth = getAuth(firebaseApp);
                    db = getFirestore(firebaseApp);
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => {
                        if (u) {
                            user = u;
                            ui.updateStatus(true);
                            app.handleRouting();
                        }
                    });
                } catch (e) { console.error(e); ui.updateStatus(false); }
            },
            handleRouting: () => {
                const params = new URLSearchParams(window.location.search);
                currentRoomId = params.get('u');
                const mySavedId = localStorage.getItem('secreto_id');
                if (!currentRoomId) {
                    ui.switchView('view-landing');
                    if (mySavedId) document.getElementById('resume-session-card').classList.remove('hidden');
                } else {
                    isOwner = (currentRoomId === mySavedId);
                    ui.switchView('view-room');
                    app.loadRoomData();
                    app.listenMessages();
                }
            },
            createRoom: () => {
                const newId = 'room_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('secreto_id', newId);
                window.location.href = `?u=${newId}`;
            },
            goToMyRoom: () => {
                const id = localStorage.getItem('secreto_id');
                if (id) window.location.href = `?u=${id}`;
            },
            copyLink: () => {
                navigator.clipboard.writeText(window.location.href);
                ui.showToast('Link tersalin!', 'success');
            },
            loadRoomData: async () => {
                if (isOwner) document.getElementById('owner-actions').classList.remove('hidden');
                else document.getElementById('visitor-actions').classList.remove('hidden');

                const docRef = doc(db, 'secreto_profiles', currentRoomId);
                const snap = await getDoc(docRef);
                const imgEl = document.getElementById('room-avatar');
                const fbEl = document.getElementById('room-avatar-fallback');

                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('room-name').innerText = data.name || "Room Tanpa Nama";
                    document.getElementById('room-desc').innerText = data.desc || "Kirim pesan rahasia di sini.";
                    if(data.avatar) {
                        imgEl.src = data.avatar;
                        imgEl.classList.remove('hidden');
                        fbEl.classList.add('hidden');
                        document.getElementById('edit-avatar-preview').src = data.avatar;
                    } else {
                        imgEl.classList.add('hidden');
                        fbEl.classList.remove('hidden');
                        fbEl.innerText = data.name ? data.name.charAt(0).toUpperCase() : "?";
                    }
                    document.getElementById('edit-name').value = data.name || "";
                    document.getElementById('edit-desc').value = data.desc || "";
                } else {
                    document.getElementById('room-name').innerText = isOwner ? "Room Anda" : "Rahasia Room";
                    imgEl.classList.add('hidden');
                    fbEl.classList.remove('hidden');
                    fbEl.innerText = "?";
                }
                if (isOwner) document.getElementById('badge-owner').classList.remove('hidden');
            },
            saveProfile: async () => {
                if (!isOwner) return;
                ui.showToast('Menyimpan...', 'info');
                const name = document.getElementById('edit-name').value;
                const desc = document.getElementById('edit-desc').value;
                const avatarSrc = document.getElementById('edit-avatar-preview').src;
                const data = { name, desc };
                if (avatarSrc.startsWith('data:')) data.avatar = avatarSrc; 
                try {
                    await setDoc(doc(db, 'secreto_profiles', currentRoomId), data, { merge: true });
                    ui.closeModal('modal-settings');
                    ui.showToast('Profil diperbarui!', 'success');
                    app.loadRoomData();
                } catch(e) { ui.showToast('Gagal simpan', 'error'); }
            },
            sendMessage: async () => {
                const sender = document.getElementById('input-sender').value.trim() || 'Anonim';
                const text = document.getElementById('input-message').value.trim();
                const btn = document.getElementById('btn-send');
                
                if (!text && !currentFile.base64) { ui.showToast('Tulis pesan dulu!', 'error'); return; }
                
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>`;
                lucide.createIcons();
                
                try {
                    await addDoc(collection(db, 'secreto_messages'), {
                        roomId: currentRoomId,
                        sender: sender,
                        text: text,
                        file: currentFile.base64 ? currentFile : null,
                        timestamp: serverTimestamp(),
                        senderUid: user.uid,
                        upvotes: 0,
                        downvotes: 0,
                        score: 0,
                        comments: []
                    });
                    document.getElementById('input-message').value = '';
                    media.clear();
                    ui.showToast('Terkirim!', 'success');
                } catch(e) { 
                    console.error(e);
                    ui.showToast('Gagal kirim', 'error'); 
                } finally { 
                    btn.disabled = false; 
                    btn.innerHTML = `Kirim <i data-lucide="send" class="w-4 h-4"></i>`; 
                    lucide.createIcons(); 
                }
            },
            listenMessages: () => {
                const q = query(collection(db, 'secreto_messages'), where('roomId', '==', currentRoomId));
                onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(d => ({ id: d.id, ...d.data(), ts: d.data().timestamp?.toDate() }));
                    
                    const searchVal = document.getElementById('search-input').value.toLowerCase();
                    const filteredMsgs = msgs.filter(m => (m.text && m.text.toLowerCase().includes(searchVal)) || (m.sender && m.sender.toLowerCase().includes(searchVal)));

                    const sortBy = document.getElementById('sort-select').value;
                    if (sortBy === 'newest') {
                        filteredMsgs.sort((a, b) => (b.ts || 0) - (a.ts || 0));
                    } else if (sortBy === 'oldest') {
                        filteredMsgs.sort((a, b) => (a.ts || 0) - (b.ts || 0));
                    } else if (sortBy === 'popular') {
                        filteredMsgs.sort((a, b) => (b.score || 0) - (a.score || 0));
                    }

                    document.getElementById('msg-count').innerText = filteredMsgs.length;
                    const container = document.getElementById('feed-container');
                    container.innerHTML = '';
                    
                    if (filteredMsgs.length === 0) {
                        container.innerHTML = `<div class="text-center py-10 opacity-50"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i><p class="text-sm font-medium text-gray-400">Belum ada pesan.</p></div>`;
                        lucide.createIcons();
                        return;
                    }
                    
                    filteredMsgs.forEach(msg => {
                        const canDelete = isOwner || (user && msg.senderUid === user.uid);
                        const time = msg.ts ? msg.ts.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                        
                        // Check User Vote Status
                        const myVote = localStorage.getItem(`vote_${msg.id}`);
                        const upClass = myVote === 'up' ? 'text-green-600 font-extrabold bg-green-50' : 'text-gray-400 hover:text-green-600 hover:bg-gray-100';
                        const downClass = myVote === 'down' ? 'text-red-500 font-extrabold bg-red-50' : 'text-gray-400 hover:text-red-500 hover:bg-gray-100';
                        const scoreColor = (msg.score > 0) ? 'text-green-600' : (msg.score < 0 ? 'text-red-500' : 'text-gray-500');

                        let mediaHtml = '';
                        if (msg.file) {
                            if (msg.file.type === 'image') mediaHtml = `<img src="${msg.file.base64}" class="mt-3 rounded-lg w-full max-h-80 object-cover border border-gray-100">`;
                            else if (msg.file.type === 'audio') mediaHtml = `<div class="mt-3"><audio controls src="${msg.file.base64}"></audio></div>`;
                            else if (msg.file.type === 'file') mediaHtml = `<div class="mt-3 flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-100 text-sm text-gray-700"><i data-lucide="file-text" class="w-4 h-4"></i> ${msg.file.name}</div>`;
                        }

                        const el = document.createElement('div');
                        el.className = "bg-white p-5 rounded-2xl shadow-sm border border-gray-100 transition hover:shadow-md";
                        
                        el.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2.5">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-xs font-bold text-gray-600 uppercase">${msg.sender.charAt(0)}</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-900">${escapeHtml(msg.sender)}</h4>
                                        <p class="text-[10px] text-gray-400 font-medium">${time}</p>
                                    </div>
                                </div>
                                ${canDelete ? `<button onclick="window.deleteMessage('${msg.id}')" class="text-gray-300 hover:text-red-500 p-1.5 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                            </div>
                            
                            <div class="pl-11">
                                <p class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.text)}</p>
                                ${mediaHtml}
                                
                                <div class="flex items-center gap-4 mt-4 pt-3 border-t border-gray-50">
                                    <div class="flex items-center gap-1 bg-white border border-gray-200 rounded-full px-1.5 py-1 shadow-sm">
                                        <button onclick="window.voteMessage('${msg.id}', 'up')" class="${upClass} transition p-1.5 rounded-full active:scale-90"><i data-lucide="chevron-up" class="w-5 h-5"></i></button>
                                        <span class="text-xs font-bold ${scoreColor} min-w-[20px] text-center transition-colors">${msg.score || 0}</span>
                                        <button onclick="window.voteMessage('${msg.id}', 'down')" class="${downClass} transition p-1.5 rounded-full active:scale-90"><i data-lucide="chevron-down" class="w-5 h-5"></i></button>
                                    </div>
                                    
                                    <button onclick="window.addComment('${msg.id}')" class="flex items-center gap-1.5 text-gray-400 hover:text-black transition px-3 py-1.5 hover:bg-gray-50 rounded-full group active:scale-95">
                                        <i data-lucide="message-square" class="w-4 h-4 group-hover:fill-black/10 transition"></i>
                                        <span class="text-[11px] font-bold">${msg.comments ? msg.comments.length : 0}</span>
                                    </button>
                                </div>

                                ${msg.comments && msg.comments.length > 0 ? `
                                    <div class="mt-3 space-y-2 border-l-2 border-gray-100 pl-3">
                                        ${msg.comments.map(c => `
                                            <div class="bg-gray-50/80 p-2 rounded-lg">
                                                <p class="text-[11px] text-gray-700"><span class="font-bold text-gray-900">${c.sender}:</span> ${escapeHtml(c.text)}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        container.appendChild(el);
                    });
                    lucide.createIcons();
                });
            }
        };

        window.app = app; window.ui = ui; window.media = media;
        
        window.deleteMessage = async (id) => {
            if(!confirm("Hapus pesan ini?")) return;
            try { await deleteDoc(doc(db, 'secreto_messages', id)); ui.showToast('Pesan dihapus', 'info'); } catch(e) { ui.showToast('Gagal hapus', 'error'); }
        };
        
        // LOGIKA VOTING CERDAS (TOGGLE & SWITCH)
        window.voteMessage = async (msgId, type) => {
            const docRef = doc(db, 'secreto_messages', msgId);
            const snap = await getDoc(docRef);
            if (!snap.exists()) return;

            let { upvotes = 0, downvotes = 0 } = snap.data();
            
            // Cek status vote user saat ini di localStorage
            const currentVote = localStorage.getItem(`vote_${msgId}`);
            let newVoteState = null;

            // Logika Toggle & Switch
            if (type === 'up') {
                if (currentVote === 'up') {
                    // UNVOTE: Sudah upvote, klik lagi -> Netral
                    upvotes--;
                    newVoteState = null;
                } else if (currentVote === 'down') {
                    // SWITCH: Dari down ke up
                    downvotes--;
                    upvotes++;
                    newVoteState = 'up';
                } else {
                    // VOTE BARU: Dari netral ke up
                    upvotes++;
                    newVoteState = 'up';
                }
            } else if (type === 'down') {
                if (currentVote === 'down') {
                    // UNVOTE: Sudah downvote, klik lagi -> Netral
                    downvotes--;
                    newVoteState = null;
                } else if (currentVote === 'up') {
                    // SWITCH: Dari up ke down
                    upvotes--;
                    downvotes++;
                    newVoteState = 'down';
                } else {
                    // VOTE BARU: Dari netral ke down
                    downvotes++;
                    newVoteState = 'down';
                }
            }
            
            try {
                // Update Firestore
                await updateDoc(docRef, {
                    upvotes,
                    downvotes,
                    score: upvotes - downvotes
                });

                // Update LocalStorage
                if (newVoteState) {
                    localStorage.setItem(`vote_${msgId}`, newVoteState);
                    ui.showToast(newVoteState === 'up' ? 'Upvoted!' : 'Downvoted!', 'success');
                } else {
                    localStorage.removeItem(`vote_${msgId}`);
                    ui.showToast('Vote dibatalkan', 'info');
                }
            } catch (e) {
                console.error(e);
                ui.showToast('Gagal memproses suara', 'error');
            }
        };

        window.addComment = async (msgId) => {
            const commentText = prompt("Tulis komentar anonim Anda:");
            if (!commentText || commentText.trim() === "") return;

            const docRef = doc(db, 'secreto_messages', msgId);
            try {
                await updateDoc(docRef, {
                    comments: arrayUnion({
                        text: commentText,
                        timestamp: new Date().toISOString(),
                        sender: "Anonim"
                    })
                });
                ui.showToast('Komentar berhasil dikirim!', 'success');
            } catch (e) {
                console.error(e);
                ui.showToast('Gagal mengirim komentar', 'error');
            }
        };

        function escapeHtml(text) { return text ? text.replace(/</g, "&lt;") : ""; }
        app.init();
    </script>
</body>
</html>
